<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>드론 시뮬레이터 - 블록 코딩</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            overflow: hidden; background: #1a1a2e;
            display: flex; flex-direction: column; height: 100vh;
        }

        /* 상단 툴바 */
        #toolbar {
            height: 50px; background: #16213e;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 1px solid #2a2a4a;
            flex-shrink: 0;
        }
        #toolbar .left { display: flex; align-items: center; gap: 10px; }
        #toolbar .center { display: flex; gap: 8px; }
        #toolbar .right { display: flex; align-items: center; gap: 10px; }

        .back-link {
            color: #88aacc; text-decoration: none; font-size: 13px;
            padding: 6px 12px; border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .back-link:hover { background: rgba(255,255,255,0.05); }

        .toolbar-title { color: #4a9eff; font-size: 16px; font-weight: bold; }

        .tool-btn {
            padding: 8px 20px; border: none; border-radius: 6px;
            font-size: 13px; font-weight: bold; cursor: pointer;
            transition: all 0.2s; font-family: inherit;
        }
        .tool-btn.run { background: #2d8f4e; color: #fff; }
        .tool-btn.run:hover { background: #34a85a; }
        .tool-btn.run.running { background: #cc4444; }
        .tool-btn.stop { background: #cc4444; color: #fff; }
        .tool-btn.stop:hover { background: #dd5555; }
        .tool-btn.reset { background: #555; color: #fff; }
        .tool-btn.reset:hover { background: #666; }

        .speed-control {
            display: flex; align-items: center; gap: 6px;
            color: #88aacc; font-size: 12px;
        }
        .speed-control select {
            background: #2a2a4a; color: #fff; border: 1px solid #444;
            padding: 4px 8px; border-radius: 4px; font-size: 12px;
        }

        /* 메인 분할 영역 */
        #main-container {
            flex: 1; display: flex; overflow: hidden;
        }

        /* 왼쪽: Blockly 에디터 */
        #blockly-panel {
            width: 55%; height: 100%;
            border-right: 2px solid #2a2a4a;
            position: relative;
        }
        #blocklyDiv {
            width: 100%; height: 100%;
        }

        /* 오른쪽: 3D 뷰 + 코드 뷰 */
        #right-panel {
            width: 45%; display: flex; flex-direction: column;
        }

        /* 3D 시뮬레이터 */
        #sim-container {
            flex: 1; position: relative; background: #000;
        }
        #sim-container canvas {
            width: 100%; height: 100%; display: block;
        }

        /* 실행 상태 표시 */
        #exec-status {
            position: absolute; top: 10px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: #4a9eff;
            padding: 6px 16px; border-radius: 15px;
            font-size: 12px; z-index: 10;
            display: none;
        }
        #exec-status.active { display: block; }

        /* 코드 뷰 패널 */
        #code-panel {
            height: 180px; background: #0d1117;
            border-top: 1px solid #2a2a4a;
            overflow: auto; flex-shrink: 0;
        }
        #code-panel-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 6px 12px; background: #161b22;
            border-bottom: 1px solid #2a2a4a;
        }
        #code-panel-header span {
            color: #88aacc; font-size: 12px;
        }
        .toggle-code-btn {
            background: none; border: 1px solid #444;
            color: #88aacc; padding: 2px 10px; border-radius: 3px;
            font-size: 11px; cursor: pointer;
        }
        #code-output {
            padding: 10px; color: #c9d1d9;
            font-family: 'Courier New', monospace;
            font-size: 13px; white-space: pre-wrap;
            line-height: 1.6;
        }

        /* 미션 패널 */
        #mission-panel {
            position: absolute; top: 60px; right: 10px;
            background: rgba(0,0,0,0.7); border-radius: 8px;
            padding: 10px; z-index: 10; min-width: 200px;
            display: none;
        }
        #mission-panel.active { display: block; }
        #mission-panel h4 {
            color: #4a9eff; font-size: 13px; margin-bottom: 8px;
        }
        .mission-obj {
            color: #aabbcc; font-size: 12px; padding: 3px 0;
        }
        .mission-obj.done { color: #44ff88; text-decoration: line-through; }

        /* 디버그 오버레이 */
        #debug-overlay {
            position: absolute; bottom: 5px; right: 5px;
            background: rgba(0,0,0,0.75); color: #aaddaa;
            padding: 6px 10px; border-radius: 6px;
            font-family: 'Courier New', monospace; font-size: 10px;
            line-height: 1.5; z-index: 15;
            pointer-events: none; white-space: pre;
            min-width: 180px;
        }
        #debug-overlay .lbl { color: #88aacc; }
        #debug-overlay .tgt { color: #ffcc66; }
        #debug-overlay .inp { color: #cc88ff; }
    </style>
</head>
<body>
    <!-- 툴바 -->
    <div id="toolbar">
        <div class="left">
            <a href="index.html" class="back-link">&#x2B05; 비행 모드</a>
            <span class="toolbar-title">&#x1F9E9; 블록 코딩</span>
            <a href="coding.html" class="back-link" style="border-color:rgba(255,123,114,0.4);color:#ff7b72;">&#x1F4BB; 텍스트 코딩</a>
        </div>
        <div class="center">
            <button class="tool-btn run" id="btn-run">&#x25B6; 실행</button>
            <button class="tool-btn stop" id="btn-stop">&#x23F9; 정지</button>
            <button class="tool-btn reset" id="btn-reset">&#x21BA; 리셋</button>
            <button class="tool-btn" id="btn-mission" style="background:#4a9eff;color:#fff;">&#x1F3AF; 미션</button>
            <button class="tool-btn" id="btn-export-code" style="background:#ff8844;color:#fff;">&#x1F4DD; 텍스트 코딩으로</button>
        </div>
        <div class="right">
            <span id="mode-progress" style="color:#88ccff;font-size:12px;margin-right:6px;"></span>
            <div class="speed-control">
                <span>속도:</span>
                <select id="speed-select">
                    <option value="0.5">느리게</option>
                    <option value="1" selected>보통</option>
                    <option value="2">빠르게</option>
                </select>
            </div>
        </div>
    </div>

    <!-- 메인 -->
    <div id="main-container">
        <!-- Blockly 에디터 -->
        <div id="blockly-panel">
            <div id="blocklyDiv"></div>
        </div>

        <!-- 오른쪽 패널 -->
        <div id="right-panel">
            <div id="sim-container">
                <div id="exec-status">대기 중</div>
                <div id="debug-overlay"></div>
            </div>
            <div id="code-panel">
                <div id="code-panel-header">
                    <span>생성된 JavaScript 코드</span>
                    <button class="toggle-code-btn" id="btn-toggle-code">숨기기</button>
                </div>
                <pre id="code-output">// 블록을 조합하면 여기에 코드가 표시됩니다.</pre>
            </div>
        </div>
    </div>

    <!-- 에러 핸들러 -->
    <script>
    window.onerror = function(msg, url, line, col, error) {
        var d = document.createElement('div');
        d.style.cssText = 'position:fixed;top:0;left:0;right:0;background:red;color:white;padding:15px;z-index:99999;font-size:14px;font-family:monospace;white-space:pre-wrap;';
        d.textContent = 'ERROR: ' + msg + '\nFile: ' + url.split('/').pop() + ':' + line;
        document.body.appendChild(d);
    };
    </script>

    <!-- Libraries -->
    <script src="../shared/three.min.js?v=5"></script>
    <script src="../shared/blockly.min.js?v=5"></script>
    <script src="../shared/blockly-blocks.min.js?v=5"></script>
    <script src="../shared/blockly-javascript.min.js?v=5"></script>

    <!-- Shared -->
    <script src="../shared/drone-physics.js?v=5"></script>
    <script src="../shared/drone-model.js?v=5"></script>
    <script src="../shared/world.js?v=5"></script>
    <script src="../shared/camera.js?v=5"></script>
    <script src="../shared/ui-components.js?v=5"></script>
    <script src="../shared/sensors.js?v=5"></script>
    <script src="../shared/autopilot.js?v=5"></script>
    <script src="../shared/mission-framework.js?v=5"></script>

    <!-- Blockly custom -->
    <script src="blockly/blocks.js?v=5"></script>
    <script src="blockly/generators.js?v=5"></script>
    <script src="js/blockly-bridge.js?v=5"></script>
    <script src="js/missions-blockly.js?v=5"></script>

    <!-- Toolbox (load as text) -->
    <script>
    (function () {
        'use strict';

        var DroneSim = window.DroneSim;
        var scene, renderer, camera, clock;
        var physics, droneModel, world, cameraSystem;
        var sensors, autopilot;
        var messageDisplay;
        var bridge, workspace;
        var missionManager, missionUI;
        var currentMissionDef = null;

        function initSimulator() {
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x87ceeb, 80, 200);

            var container = document.getElementById('sim-container');
            var w = container.clientWidth;
            var h = container.clientHeight;

            camera = new THREE.PerspectiveCamera(60, w / h, 0.1, 500);
            camera.position.set(0, 5, 8);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(w, h);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setClearColor(0x87ceeb);
            if (THREE.SRGBColorSpace) renderer.outputColorSpace = THREE.SRGBColorSpace;
            container.appendChild(renderer.domElement);

            clock = new THREE.Clock();

            world = new DroneSim.World(scene);
            world.create();

            physics = new DroneSim.DronePhysics({
                maxSpeed: 10, speedLimit: 10,
                autoStabilize: true, stabilizeRate: 4.0,
                maxTiltAngle: Math.PI / 6, batteryDrainRate: 0, dragCoefficient: 0.4
            });

            droneModel = new DroneSim.DroneModel();
            scene.add(droneModel.getModel());

            cameraSystem = new DroneSim.CameraSystem(camera);
            cameraSystem.setTarget(droneModel.getModel());

            sensors = new DroneSim.DroneSensors(scene, physics);
            autopilot = new DroneSim.Autopilot(physics);
            autopilot.setHome();

            messageDisplay = new DroneSim.MessageDisplay(container);

            window.addEventListener('resize', function () {
                var w = container.clientWidth;
                var h = container.clientHeight;
                camera.aspect = w / h;
                camera.updateProjectionMatrix();
                renderer.setSize(w, h);
            });
        }

        function initBlockly() {
            // Toolbox XML 직접 정의
            var toolboxXml = '<xml xmlns="https://developers.google.com/blockly/xml">' +
                '<category name="기본 동작" colour="#4a9eff">' +
                    '<block type="drone_takeoff"></block>' +
                    '<block type="drone_land"></block>' +
                    '<block type="drone_hover"><value name="SECONDS"><shadow type="math_number"><field name="NUM">3</field></shadow></value></block>' +
                    '<block type="drone_wait"><value name="SECONDS"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>' +
                '</category>' +
                '<category name="이동" colour="#44bb77">' +
                    '<block type="drone_move_forward"><value name="DISTANCE"><shadow type="math_number"><field name="NUM">3</field></shadow></value></block>' +
                    '<block type="drone_move_backward"><value name="DISTANCE"><shadow type="math_number"><field name="NUM">3</field></shadow></value></block>' +
                    '<block type="drone_move_left"><value name="DISTANCE"><shadow type="math_number"><field name="NUM">3</field></shadow></value></block>' +
                    '<block type="drone_move_right"><value name="DISTANCE"><shadow type="math_number"><field name="NUM">3</field></shadow></value></block>' +
                    '<block type="drone_move_up"><value name="DISTANCE"><shadow type="math_number"><field name="NUM">2</field></shadow></value></block>' +
                    '<block type="drone_move_down"><value name="DISTANCE"><shadow type="math_number"><field name="NUM">2</field></shadow></value></block>' +
                '</category>' +
                '<category name="회전" colour="#44bb77">' +
                    '<block type="drone_turn_left"><value name="ANGLE"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>' +
                    '<block type="drone_turn_right"><value name="ANGLE"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>' +
                '</category>' +
                '<category name="센서" colour="#bb44aa">' +
                    '<block type="drone_get_altitude"></block>' +
                    '<block type="drone_get_speed"></block>' +
                    '<block type="drone_get_battery"></block>' +
                    '<block type="drone_get_front_distance"></block>' +
                    '<block type="drone_get_position_x"></block>' +
                    '<block type="drone_get_position_z"></block>' +
                    '<block type="drone_get_distance_to"><value name="X"><shadow type="math_number"><field name="NUM">10</field></shadow></value><value name="Z"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>' +
                '</category>' +
                '<category name="자율비행" colour="#ff8844">' +
                    '<block type="drone_fly_to"><value name="X"><shadow type="math_number"><field name="NUM">10</field></shadow></value><value name="Y"><shadow type="math_number"><field name="NUM">3</field></shadow></value><value name="Z"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>' +
                    '<block type="drone_return_home"></block>' +
                    '<block type="drone_set_speed"><value name="SPEED"><shadow type="math_number"><field name="NUM">3</field></shadow></value></block>' +
                    '<block type="drone_follow_path"></block>' +
                    '<block type="drone_add_waypoint"><value name="X"><shadow type="math_number"><field name="NUM">5</field></shadow></value><value name="Z"><shadow type="math_number"><field name="NUM">5</field></shadow></value><value name="Y"><shadow type="math_number"><field name="NUM">3</field></shadow></value></block>' +
                '</category>' +
                '<sep></sep>' +
                '<category name="논리" colour="#5b80a5">' +
                    '<block type="controls_if"></block>' +
                    '<block type="controls_ifelse"></block>' +
                    '<block type="logic_compare"></block>' +
                    '<block type="logic_operation"></block>' +
                    '<block type="logic_boolean"></block>' +
                '</category>' +
                '<category name="반복" colour="#5ba55b">' +
                    '<block type="controls_repeat_ext"><value name="TIMES"><shadow type="math_number"><field name="NUM">4</field></shadow></value></block>' +
                    '<block type="controls_whileUntil"></block>' +
                '</category>' +
                '<category name="숫자" colour="#5b67a5">' +
                    '<block type="math_number"><field name="NUM">0</field></block>' +
                    '<block type="math_arithmetic"></block>' +
                '</category>' +
                '<category name="변수" colour="#a55b80" custom="VARIABLE"></category>' +
                '<category name="함수" colour="#995ba5" custom="PROCEDURE"></category>' +
            '</xml>';

            workspace = Blockly.inject('blocklyDiv', {
                toolbox: toolboxXml,
                grid: { spacing: 20, length: 3, colour: '#333', snap: true },
                zoom: { controls: true, wheel: true, startScale: 0.9, maxScale: 2, minScale: 0.3 },
                trashcan: true,
                renderer: 'zelos',
                theme: Blockly.Theme.defineTheme('dark', {
                    base: Blockly.Themes.Classic,
                    componentStyles: {
                        workspaceBackgroundColour: '#1a1a2e',
                        toolboxBackgroundColour: '#16213e',
                        toolboxForegroundColour: '#fff',
                        flyoutBackgroundColour: '#1a1a3e',
                        flyoutForegroundColour: '#ddd',
                        flyoutOpacity: 0.9,
                        scrollbarColour: '#444',
                        scrollbarOpacity: 0.5
                    }
                })
            });

            // 코드 변경 시 실시간 미리보기
            workspace.addChangeListener(function () {
                if (bridge && !bridge.isRunning) {
                    updateCodePreview();
                }
            });
        }

        function updateCodePreview() {
            try {
                var gen = Blockly.JavaScript;
                gen.STATEMENT_PREFIX = '';
                var code = gen.workspaceToCode(workspace);
                document.getElementById('code-output').textContent = code || '// 블록을 조합하면 여기에 코드가 표시됩니다.';
            } catch (e) { /* ignore */ }
        }

        function initBridge() {
            bridge = new DroneSim.BlocklyBridge(physics, workspace);
            bridge.drone.setAutopilot(autopilot);
            bridge.drone.setSensors(sensors);

            bridge.drone.onAction = function (action) {
                var status = document.getElementById('exec-status');
                status.textContent = action;
                status.classList.add('active');
            };

            bridge.onStart = function () {
                document.getElementById('btn-run').textContent = '실행 중...';
                document.getElementById('btn-run').classList.add('running');
                document.getElementById('exec-status').classList.add('active');
            };

            bridge.onComplete = function () {
                document.getElementById('btn-run').textContent = '▶ 실행';
                document.getElementById('btn-run').classList.remove('running');
                document.getElementById('exec-status').textContent = '완료!';
                setTimeout(function () {
                    document.getElementById('exec-status').classList.remove('active');
                }, 2000);
                messageDisplay.show('프로그램 실행 완료!', 'success', 2000);
            };

            bridge.onError = function (msg) {
                document.getElementById('btn-run').textContent = '▶ 실행';
                document.getElementById('btn-run').classList.remove('running');
                document.getElementById('exec-status').classList.remove('active');
                messageDisplay.show('오류: ' + msg, 'error', 3000);
            };

            bridge.onCodeGenerated = function (code) {
                document.getElementById('code-output').textContent = code;
            };
        }

        function initMissions() {
            if (!DroneSim.MissionManager || !DroneSim.createBlocklyMissions || !DroneSim.MissionSelectUI) return;

            missionManager = new DroneSim.MissionManager('drone-blockly-progress');
            var missions = DroneSim.createBlocklyMissions();
            missions.forEach(function (m) { missionManager.addMission(m); });

            missionManager.onMissionStart = function (mission) {
                currentMissionDef = mission;
                var origMission = missions[mission.index];
                if (origMission.setup) origMission.setup(scene);
                currentMissionDef._origMission = origMission;

                physics.reset();
                if (messageDisplay) messageDisplay.show(mission.name + ' 시작!', 'info', 2000);
                missionUI.showMissionHUD(mission);
            };

            missionManager.onMissionComplete = function (result) {
                if (currentMissionDef && currentMissionDef._origMission && currentMissionDef._origMission.cleanup) {
                    currentMissionDef._origMission.cleanup(scene);
                }
                missionUI.hideMissionHUD();
                missionUI.showResult(result,
                    function () { startMission(result.mission.index); },
                    function () { startMission(result.mission.index + 1); },
                    function () { showMissionSelect(); }
                );
            };

            missionManager.onMissionFail = function (result) {
                if (currentMissionDef && currentMissionDef._origMission && currentMissionDef._origMission.cleanup) {
                    currentMissionDef._origMission.cleanup(scene);
                }
                missionUI.hideMissionHUD();
                missionUI.showResult(result,
                    function () { startMission(result.mission.index); },
                    null,
                    function () { showMissionSelect(); }
                );
            };

            missionManager.onObjectiveUpdate = function (obj) {
                if (messageDisplay) messageDisplay.show(obj.description + ' 완료!', 'success', 1500);
            };

            missionManager.onAllMissionsComplete = function () {
                var modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;inset:0;z-index:2000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);';
                modal.innerHTML = '<div style="background:#1a1a2e;border:2px solid rgba(255,123,114,0.5);border-radius:16px;padding:40px 48px;text-align:center;max-width:420px;color:#fff;font-family:inherit;">' +
                    '<div style="font-size:48px;margin-bottom:16px;">&#x1F389;</div>' +
                    '<h2 style="font-size:22px;margin-bottom:12px;color:#ff7b72;">블록 코딩 마스터!</h2>' +
                    '<p style="font-size:15px;margin-bottom:8px;line-height:1.6;">블록 코딩을 마스터했어요!</p>' +
                    '<p style="font-size:14px;color:#aaa;margin-bottom:28px;">이제 직접 코드를 작성해볼까요?</p>' +
                    '<div style="display:flex;gap:12px;justify-content:center;">' +
                    '<button id="modal-next-stage" style="padding:12px 24px;border-radius:8px;border:none;background:#ff7b72;color:#fff;font-size:15px;font-weight:bold;cursor:pointer;font-family:inherit;">&#x1F4BB; 텍스트 코딩 시작하기</button>' +
                    '<button id="modal-practice" style="padding:12px 24px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:#ccc;font-size:15px;cursor:pointer;font-family:inherit;">더 연습하기</button>' +
                    '</div></div>';
                document.body.appendChild(modal);
                document.getElementById('modal-next-stage').addEventListener('click', function () {
                    window.location.href = 'coding.html';
                });
                document.getElementById('modal-practice').addEventListener('click', function () {
                    modal.remove();
                });
            };

            missionUI = new DroneSim.MissionSelectUI(missionManager,
                function (idx) { startMission(idx); },
                function () { /* 자유 코딩 */ }
            );
        }

        function showMissionSelect() {
            if (!missionManager || !missionUI) return;
            if (missionManager.isRunning) {
                missionManager.stopMission();
                missionUI.hideMissionHUD();
                if (currentMissionDef && currentMissionDef._origMission && currentMissionDef._origMission.cleanup) {
                    currentMissionDef._origMission.cleanup(scene);
                }
            }
            physics.reset();
            bridge.stop();
            missionUI.show();
        }

        function startMission(index) {
            if (!missionManager) return;
            if (index >= missionManager.missions.length) {
                if (messageDisplay) messageDisplay.show('모든 미션을 완료했습니다!', 'success', 3000);
                return;
            }
            if (!missionManager.isMissionUnlocked(index)) {
                if (messageDisplay) messageDisplay.show('이전 미션을 먼저 완료하세요!', 'warning', 2000);
                return;
            }
            physics.reset();
            missionManager.startMission(index);
        }

        function bindButtons() {
            document.getElementById('btn-run').addEventListener('click', function () {
                if (bridge.isRunning) return;
                physics.reset();
                bridge.run();
            });

            document.getElementById('btn-stop').addEventListener('click', function () {
                bridge.stop();
                autopilot.stop();
                document.getElementById('btn-run').textContent = '▶ 실행';
                document.getElementById('btn-run').classList.remove('running');
                document.getElementById('exec-status').classList.remove('active');
                messageDisplay.show('정지됨', 'warning', 1000);
            });

            document.getElementById('btn-reset').addEventListener('click', function () {
                bridge.stop();
                physics.reset();
                droneModel.updateFromPhysics(physics.getState());
                document.getElementById('btn-run').textContent = '▶ 실행';
                document.getElementById('btn-run').classList.remove('running');
                document.getElementById('exec-status').classList.remove('active');
                messageDisplay.show('리셋 완료', 'info', 1000);
            });

            document.getElementById('btn-toggle-code').addEventListener('click', function () {
                var panel = document.getElementById('code-panel');
                var btn = this;
                if (panel.style.height === '30px') {
                    panel.style.height = '180px';
                    btn.textContent = '숨기기';
                } else {
                    panel.style.height = '30px';
                    btn.textContent = '보이기';
                }
            });

            document.getElementById('btn-mission').addEventListener('click', function () {
                showMissionSelect();
            });

            document.getElementById('btn-export-code').addEventListener('click', function () {
                var code = Blockly.JavaScript.workspaceToCode(workspace);
                if (!code || code.trim() === '') {
                    alert('먼저 블록을 조립해주세요!');
                    return;
                }
                localStorage.setItem('drone-blockly-export', code);

                var modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';
                modal.innerHTML =
                    '<div style="background:#1a1a2e;border:2px solid #4a9eff;border-radius:16px;padding:30px;text-align:center;max-width:400px;">' +
                        '<h3 style="color:#4a9eff;margin:0 0 15px;">코드가 저장되었어요! &#x1F4CB;</h3>' +
                        '<p style="color:#ccc;margin:0 0 20px;line-height:1.6;">블록으로 만든 코드를 텍스트 코딩 에디터로 가져갈 수 있어요.<br>직접 수정하면서 코딩을 배워보세요!</p>' +
                        '<button onclick="window.location.href=\'coding.html?from=blockly\'" style="background:#4a9eff;color:#fff;border:none;padding:12px 24px;border-radius:8px;font-size:16px;cursor:pointer;margin:5px;">텍스트 코딩으로 이동</button>' +
                        '<button onclick="this.closest(\'div\').parentElement.remove()" style="background:#333;color:#ccc;border:1px solid #555;padding:12px 24px;border-radius:8px;font-size:16px;cursor:pointer;margin:5px;">계속 블록 코딩</button>' +
                    '</div>';
                document.body.appendChild(modal);
            });
        }

        var _debugEl = null;
        var _debugCounter = 0;
        function animate() {
            requestAnimationFrame(animate);
            var dt = Math.min(clock.getDelta(), 0.05);

            // 코딩 입력 > 자율비행 > 호버링 우선순위
            var overrideInput = bridge.drone.getInputOverride ? bridge.drone.getInputOverride() : null;
            var autoInput = autopilot.update(dt);
            var activeInput = null;
            if (overrideInput && physics.isFlying && !physics.isLanding) {
                activeInput = overrideInput;
                physics.update(dt, overrideInput);
            } else if (autoInput && physics.isFlying && !physics.isLanding) {
                activeInput = autoInput;
                physics.update(dt, autoInput);
            } else {
                physics.update(dt, {});
            }

            var state = physics.getState();
            droneModel.updateFromPhysics(state);
            droneModel.updatePropellers(dt, physics.isFlying ? 0.5 : 0);
            cameraSystem.update(dt);

            // 미션 업데이트
            if (missionManager && missionManager.isRunning && currentMissionDef) {
                if (currentMissionDef._origMission && currentMissionDef._origMission.frameUpdate) {
                    currentMissionDef._origMission.frameUpdate(state, missionManager.missionTime, dt);
                    // frameUpdate 후 미션 상태 동기화
                    var origM_ = currentMissionDef._origMission;
                    for (var k in origM_) {
                        if ((k.charAt(0) === '_' || k === 'collectibles') && origM_.hasOwnProperty(k)) {
                            currentMissionDef[k] = origM_[k];
                        }
                    }
                }
                missionManager.update(dt, state);
                if (missionUI) missionUI.updateMissionHUD(currentMissionDef, missionManager.missionTime);
            }

            // 디버그 오버레이 업데이트 (5프레임마다)
            if (++_debugCounter % 5 === 0) {
                if (!_debugEl) _debugEl = document.getElementById('debug-overlay');
                if (_debugEl) {
                    var p = state.position;
                    var v = state.velocity;
                    var spd = state.speed;
                    var lines = '<span class="lbl">Pos</span> X:' + p.x.toFixed(1) + ' Y:' + p.y.toFixed(1) + ' Z:' + p.z.toFixed(1);
                    lines += '\n<span class="lbl">Vel</span> ' + v.x.toFixed(1) + ',' + v.y.toFixed(1) + ',' + v.z.toFixed(1) + '  Spd:' + spd.toFixed(1);
                    if (autopilot.target) {
                        var t = autopilot.target;
                        var dx = t.x - p.x, dy = t.y - p.y, dz = t.z - p.z;
                        var dist = Math.sqrt(dx*dx+dy*dy+dz*dz);
                        lines += '\n<span class="tgt">Tgt</span> ' + t.x.toFixed(1) + ',' + t.y.toFixed(1) + ',' + t.z.toFixed(1) + '  D:' + dist.toFixed(1) + 'm';
                    }
                    if (activeInput) {
                        lines += '\n<span class="inp">In</span>  P:' + (activeInput.pitch||0).toFixed(2) + ' R:' + (activeInput.roll||0).toFixed(2) + ' T:' + (activeInput.throttle||0).toFixed(2) + ' Y:' + (activeInput.yaw||0).toFixed(2);
                    }
                    _debugEl.innerHTML = lines;
                }
            }

            renderer.render(scene, camera);
        }

        // 초기화
        initSimulator();
        initBlockly();
        initBridge();
        initMissions();
        bindButtons();
        animate();
    })();
    </script>

    <!-- 블록 코딩 진행도 표시 -->
    <script>
    (function() {
        function updateModeProgress() {
            var data = JSON.parse(localStorage.getItem('drone-blockly-progress') || '{}');
            var completed = 0;
            for (var i = 0; i < 6; i++) {
                if (data['mission_' + i] && data['mission_' + i].completed) completed++;
            }
            var el = document.getElementById('mode-progress');
            if (el) el.textContent = '&#x1F3AF; 과제 ' + completed + '/6 완료';
        }
        updateModeProgress();
    })();
    </script>
</body>
</html>
