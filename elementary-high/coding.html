<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>드론 시뮬레이터 - 텍스트 코딩</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            overflow: hidden; background: #0d1117;
            display: flex; flex-direction: column; height: 100vh;
        }

        #toolbar {
            height: 50px; background: #161b22;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 1px solid #30363d;
            flex-shrink: 0;
        }
        #toolbar .left { display: flex; align-items: center; gap: 10px; }
        #toolbar .center { display: flex; gap: 8px; }
        #toolbar .right { display: flex; align-items: center; gap: 10px; }

        .back-link {
            color: #88aacc; text-decoration: none; font-size: 13px;
            padding: 6px 12px; border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .back-link:hover { background: rgba(255,255,255,0.05); }
        .toolbar-title { color: #ff7b72; font-size: 16px; font-weight: bold; }

        .tool-btn {
            padding: 8px 20px; border: none; border-radius: 6px;
            font-size: 13px; font-weight: bold; cursor: pointer;
            transition: all 0.2s; font-family: inherit;
        }
        .tool-btn.run { background: #238636; color: #fff; }
        .tool-btn.run:hover { background: #2ea043; }
        .tool-btn.stop { background: #da3633; color: #fff; }
        .tool-btn.reset { background: #30363d; color: #c9d1d9; border: 1px solid #444; }
        .demo-btn {
            padding: 6px 14px; border-radius: 6px; font-size: 12px;
            border: 1px solid #444; background: #21262d; color: #c9d1d9;
            cursor: pointer; font-family: inherit;
        }
        .demo-btn:hover { background: #30363d; }

        #main-container { flex: 1; display: flex; overflow: hidden; }

        /* 코드 에디터 */
        #editor-panel {
            width: 55%; display: flex; flex-direction: column;
            border-right: 1px solid #30363d;
        }
        #editor-header {
            padding: 8px 15px; background: #161b22;
            border-bottom: 1px solid #30363d;
            display: flex; align-items: center; justify-content: space-between;
        }
        #editor-header .tab {
            color: #c9d1d9; font-size: 13px;
            padding: 4px 12px; border-radius: 4px;
            background: #0d1117; border: 1px solid #30363d;
        }
        #editor-header .api-hint {
            color: #8b949e; font-size: 11px;
        }
        #code-editor {
            flex: 1; width: 100%; padding: 15px;
            background: #0d1117; color: #c9d1d9; border: none;
            font-family: 'Courier New', 'Menlo', monospace;
            font-size: 14px; line-height: 1.7;
            resize: none; outline: none;
            tab-size: 2;
        }
        /* 출력 콘솔 */
        #console-panel {
            height: 120px; background: #010409;
            border-top: 1px solid #30363d;
            flex-shrink: 0; overflow-y: auto;
        }
        #console-header {
            padding: 4px 15px; background: #0d1117;
            color: #8b949e; font-size: 11px;
            border-bottom: 1px solid #21262d;
        }
        #console-output {
            padding: 8px 15px; color: #8b949e;
            font-family: 'Courier New', monospace;
            font-size: 12px; white-space: pre-wrap;
        }
        .console-log { color: #c9d1d9; }
        .console-success { color: #3fb950; }
        .console-error {
            color: #fff;
            background: #da3633;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 4px 0;
            font-size: 13px;
        }
        .console-error-detail {
            color: #8b949e;
            font-size: 11px;
            margin-top: 2px;
            padding-left: 12px;
        }
        .console-info { color: #58a6ff; }

        /* 오른쪽: 3D 뷰 */
        #right-panel { width: 45%; display: flex; flex-direction: column; }
        #sim-container { flex: 1; position: relative; background: #000; }
        #sim-container canvas { width: 100%; height: 100%; display: block; }

        #exec-status {
            position: absolute; top: 10px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: #58a6ff;
            padding: 6px 16px; border-radius: 15px;
            font-size: 12px; z-index: 10; display: none;
        }
        #exec-status.active { display: block; }

        /* API 레퍼런스 */
        #api-panel {
            height: 200px; background: #0d1117;
            border-top: 1px solid #30363d;
            overflow-y: auto; flex-shrink: 0; padding: 10px 15px;
            color: #8b949e; font-size: 12px; line-height: 1.8;
        }
        #api-panel h4 { color: #58a6ff; margin-bottom: 5px; font-size: 13px; }
        #api-panel code {
            background: #161b22; padding: 1px 5px;
            border-radius: 3px; color: #ff7b72; font-size: 12px;
        }

        /* 디버그 오버레이 */
        #debug-overlay {
            position: absolute; bottom: 5px; right: 5px;
            background: rgba(0,0,0,0.75); color: #aaddaa;
            padding: 6px 10px; border-radius: 6px;
            font-family: 'Courier New', monospace; font-size: 10px;
            line-height: 1.5; z-index: 15;
            pointer-events: none; white-space: pre;
            min-width: 180px;
        }
        #debug-overlay .lbl { color: #88aacc; }
        #debug-overlay .tgt { color: #ffcc66; }
        #debug-overlay .inp { color: #cc88ff; }
    </style>
</head>
<body>
    <div id="toolbar">
        <div class="left">
            <a href="index.html" class="back-link">&#x1F680; 비행 모드</a>
            <a href="blockly.html" class="back-link">&#x1F9E9; 블록 코딩</a>
            <span class="toolbar-title">&#x1F4BB; 텍스트 코딩</span>
        </div>
        <div class="center">
            <button class="tool-btn run" id="btn-run">&#x25B6; 실행</button>
            <button class="tool-btn stop" id="btn-stop">&#x23F9; 정지</button>
            <button class="tool-btn reset" id="btn-reset">&#x21BA; 리셋</button>
        </div>
        <div class="right">
            <span id="mode-progress" style="color:#88ccff;font-size:12px;margin-right:6px;"></span>
            <button id="btn-missions" style="background:#4a9eff;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:bold;font-family:inherit;">&#x1F3AF; 코딩 과제</button>
            <button id="btn-sandbox" style="background:#9b59b6;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:bold;font-family:inherit;">&#x1F3AE; 자유 코딩</button>
            <button class="demo-btn" id="demo-square">사각형 비행</button>
            <button class="demo-btn" id="demo-flyto">좌표 비행</button>
            <button class="demo-btn" id="demo-patrol">순찰 비행</button>
            <button class="demo-btn" id="demo-path">경로 탐색</button>
        </div>
    </div>

    <div id="main-container">
        <div id="editor-panel">
            <div id="editor-header">
                <span class="tab">main.js</span>
                <span class="api-hint">drone.함수명() 으로 드론을 조종하세요</span>
            </div>
            <textarea id="code-editor" spellcheck="false">// 드론 텍스트 코딩
// 아래 코드를 수정해서 드론을 조종해보세요!

await drone.takeoff();
await drone.moveForward(5);
await drone.turnRight(90);
await drone.moveForward(3);
await drone.hover(2);
await drone.land();
</textarea>
            <div id="console-panel">
                <div id="console-header">콘솔 출력</div>
                <div id="mission-hint" style="display:none;background:#1a3a5c;border:1px solid #4a9eff;color:#88ccff;padding:10px 15px;font-size:13px;"><strong>&#x1F4A1; 힌트:</strong> <span id="hint-text"></span></div>
                <div id="console-output"></div>
            </div>
        </div>

        <div id="right-panel">
            <div id="sim-container">
                <div id="exec-status">대기 중</div>
                <div id="debug-overlay"></div>
            </div>
            <div id="api-panel">
                <h4>드론 API 레퍼런스</h4>
                <b style="color:#4a9eff;">기본 조작</b><br>
                <code>await drone.takeoff()</code> - 이륙<br>
                <code>await drone.land()</code> - 착륙<br>
                <code>await drone.moveForward(거리)</code> - 앞으로 이동 (m)<br>
                <code>await drone.moveBackward(거리)</code> - 뒤로 이동<br>
                <code>await drone.moveLeft(거리)</code> - 왼쪽 이동<br>
                <code>await drone.moveRight(거리)</code> - 오른쪽 이동<br>
                <code>await drone.moveUp(높이)</code> - 위로 이동<br>
                <code>await drone.moveDown(높이)</code> - 아래로 이동<br>
                <code>await drone.turnLeft(각도)</code> - 왼쪽 회전 (도)<br>
                <code>await drone.turnRight(각도)</code> - 오른쪽 회전 (도)<br>
                <code>await drone.hover(초)</code> - 호버링<br>
                <code>await drone.wait(초)</code> - 대기<br>
                <br><b style="color:#ff8844;">자율비행</b><br>
                <code>await drone.flyTo(x, y, z)</code> - 좌표로 자동 비행<br>
                <code>await drone.returnHome()</code> - 홈으로 귀환<br>
                <code>await drone.followPath([{x,y,z}, ...])</code> - 경로 비행<br>
                <code>drone.setSpeed(속도)</code> - 비행 속도 설정 (1~10)<br>
                <br><b style="color:#bb44aa;">센서</b><br>
                <code>drone.getAltitude()</code> - 현재 높이<br>
                <code>drone.getSpeed()</code> - 현재 속도<br>
                <code>drone.getBattery()</code> - 배터리 잔량<br>
                <code>drone.getPositionX()</code> - X 좌표<br>
                <code>drone.getPositionZ()</code> - Z 좌표<br>
                <code>drone.getDistanceTo(x, z)</code> - 목표까지 거리<br>
                <code>console.log(값)</code> - 콘솔 출력
            </div>
        </div>
    </div>

    <!-- 에러 핸들러 -->
    <script>
    window.onerror = function(msg, url, line, col, error) {
        var d = document.createElement('div');
        d.style.cssText = 'position:fixed;top:0;left:0;right:0;background:red;color:white;padding:15px;z-index:99999;font-size:14px;font-family:monospace;white-space:pre-wrap;';
        d.textContent = 'ERROR: ' + msg + '\nFile: ' + url.split('/').pop() + ':' + line;
        document.body.appendChild(d);
    };
    </script>

    <!-- Libraries -->
    <script src="../shared/three.min.js?v=5"></script>

    <!-- Shared -->
    <script src="../shared/drone-physics.js?v=5"></script>
    <script src="../shared/drone-model.js?v=5"></script>
    <script src="../shared/world.js?v=5"></script>
    <script src="../shared/camera.js?v=5"></script>
    <script src="../shared/ui-components.js?v=5"></script>
    <script src="../shared/sensors.js?v=5"></script>
    <script src="../shared/autopilot.js?v=5"></script>
    <script src="js/blockly-bridge.js?v=5"></script>
    <script src="../shared/mission-framework.js?v=5"></script>
    <script src="js/missions-coding.js?v=5"></script>

    <script>
    (function () {
        'use strict';

        var DroneSim = window.DroneSim;
        var scene, renderer, camera, clock;
        var physics, droneModel, world, cameraSystem, sensors;
        var droneAPI;
        var isRunning = false;

        // 데모 코드
        var DEMOS = {
            square: '// 사각형 비행\n// 4번 반복하여 사각형을 그립니다\n\nawait drone.takeoff();\n\nfor (let i = 0; i < 4; i++) {\n    await drone.moveForward(5);\n    await drone.turnRight(90);\n    console.log("변 " + (i+1) + " 완료!");\n}\n\nconsole.log("사각형 완성!");\nawait drone.land();\n',
            flyto: '// 좌표 비행 (자율비행)\n// flyTo()로 원하는 좌표로 자동 비행합니다\n\nawait drone.takeoff();\nconsole.log("현재 위치: X=" + drone.getPositionX() + " Z=" + drone.getPositionZ());\n\n// 첫 번째 지점으로 비행\nconsole.log(">> 지점 A (10, 3, 0) 으로 비행!");\nawait drone.flyTo(10, 3, 0);\nconsole.log("지점 A 도착! 거리: " + drone.getDistanceTo(0, 0) + "m");\n\n// 두 번째 지점으로 비행\nconsole.log(">> 지점 B (10, 5, 10) 으로 비행!");\nawait drone.flyTo(10, 5, 10);\nconsole.log("지점 B 도착!");\n\n// 홈으로 귀환\nconsole.log(">> 홈으로 귀환!");\nawait drone.returnHome();\nconsole.log("귀환 완료!");\n\nawait drone.land();\n',
            patrol: '// 순찰 비행 (자율비행)\n// 여러 웨이포인트를 순서대로 방문합니다\n\nawait drone.takeoff();\ndrone.setSpeed(4); // 속도 4m/s\n\n// 순찰 경로 정의\nconst route = [\n    {x: 8, y: 3, z: 0},   // 동쪽\n    {x: 8, y: 4, z: -8},  // 북동쪽 (높이 올림)\n    {x: 0, y: 4, z: -8},  // 북쪽\n    {x: -8, y: 3, z: -8}, // 북서쪽\n    {x: -8, y: 3, z: 0},  // 서쪽\n    {x: 0, y: 3, z: 0}    // 출발점\n];\n\nconsole.log("순찰 시작! (" + route.length + "개 지점)");\n\n// followPath로 경로 자동 비행\nawait drone.followPath(route);\n\nconsole.log("순찰 완료!");\nconsole.log("최종 위치: X=" + drone.getPositionX() + " Z=" + drone.getPositionZ());\nawait drone.land();\n',
            path: '// 지능형 경로 탐색\n// 센서로 위치를 확인하며 목표를 찾아갑니다\n\nawait drone.takeoff();\ndrone.setSpeed(3);\n\n// 탐색할 목표 지점들\nconst targets = [\n    {x: 5, z: 5, name: "기지 A"},\n    {x: -5, z: 10, name: "기지 B"},\n    {x: -10, z: -5, name: "기지 C"}\n];\n\nfor (let i = 0; i < targets.length; i++) {\n    const t = targets[i];\n    let dist = drone.getDistanceTo(t.x, t.z);\n    console.log(">> " + t.name + " 탐색 중... (거리: " + dist + "m)");\n    \n    await drone.flyTo(t.x, 3, t.z);\n    \n    dist = drone.getDistanceTo(t.x, t.z);\n    console.log("도착! " + t.name + " (오차: " + dist + "m)");\n    await drone.hover(1);\n}\n\nconsole.log("모든 기지 탐색 완료! 귀환합니다.");\nawait drone.returnHome();\nawait drone.land();\n'
        };

        function initSimulator() {
            scene = new THREE.Scene();
            window._codingScene = scene;
            scene.fog = new THREE.Fog(0x87ceeb, 80, 200);

            var container = document.getElementById('sim-container');
            var w = container.clientWidth;
            var h = container.clientHeight;

            camera = new THREE.PerspectiveCamera(60, w / h, 0.1, 500);
            camera.position.set(0, 5, 8);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(w, h);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setClearColor(0x87ceeb);
            if (THREE.SRGBColorSpace) renderer.outputColorSpace = THREE.SRGBColorSpace;
            container.appendChild(renderer.domElement);

            clock = new THREE.Clock();

            world = new DroneSim.World(scene);
            world.create();

            physics = new DroneSim.DronePhysics({
                maxSpeed: 10, speedLimit: 10,
                autoStabilize: true, stabilizeRate: 4.0,
                batteryDrainRate: 0, dragCoefficient: 0.4
            });

            droneModel = new DroneSim.DroneModel();
            scene.add(droneModel.getModel());

            cameraSystem = new DroneSim.CameraSystem(camera);
            cameraSystem.setTarget(droneModel.getModel());

            sensors = new DroneSim.DroneSensors(scene, physics);
            var autopilot = new DroneSim.Autopilot(physics);
            autopilot.setHome();

            droneAPI = new DroneSim.DroneAPI(physics);
            droneAPI.setAutopilot(autopilot);
            droneAPI.setSensors(sensors);

            droneAPI.onAction = function (action) {
                var status = document.getElementById('exec-status');
                status.textContent = action;
                status.classList.add('active');
            };

            window.addEventListener('resize', function () {
                var w = container.clientWidth;
                var h = container.clientHeight;
                camera.aspect = w / h;
                camera.updateProjectionMatrix();
                renderer.setSize(w, h);
            });
        }

        function translateError(error) {
            var message = error.message || String(error);
            var stack = error.stack || '';
            var lineNumber = null;

            // Extract line number from stack trace
            var lineMatch = stack.match(/<anonymous>:(\d+):/);
            if (lineMatch) {
                lineNumber = parseInt(lineMatch[1]) - 1; // Adjust for wrapper function
            }

            var koreanMsg = '';
            var errorType = error.name || 'Error';

            // TypeError translations
            if (errorType === 'TypeError') {
                if (message.includes('Cannot read properties of undefined')) {
                    koreanMsg = '타입 오류: 아직 준비되지 않은 값을 사용하려고 했어요';
                } else if (message.includes('Cannot read properties of null')) {
                    koreanMsg = '타입 오류: 비어있는 값을 사용하려고 했어요';
                } else if (message.includes('is not a function')) {
                    var funcName = message.match(/(\w+) is not a function/);
                    if (funcName) {
                        koreanMsg = '타입 오류: \'' + funcName[1] + '\'은(는) 실행할 수 있는 명령이 아니에요';
                    } else {
                        koreanMsg = '타입 오류: 실행할 수 없는 것을 실행하려고 했어요';
                    }
                } else {
                    koreanMsg = '타입 오류: ' + message;
                }
            }
            // ReferenceError translations
            else if (errorType === 'ReferenceError') {
                if (message.includes('is not defined')) {
                    var varName = message.match(/(\w+) is not defined/);
                    if (varName) {
                        koreanMsg = '이름 오류: \'' + varName[1] + '\'을(를) 찾을 수 없어요. 철자를 확인해보세요!';
                    } else {
                        koreanMsg = '이름 오류: 정의되지 않은 이름을 사용했어요';
                    }
                } else {
                    koreanMsg = '이름 오류: ' + message;
                }
            }
            // SyntaxError translations
            else if (errorType === 'SyntaxError') {
                if (message.includes('Unexpected token')) {
                    koreanMsg = '문법 오류: 예상하지 못한 글자가 있어요. 괄호나 세미콜론을 확인해보세요!';
                } else if (message.includes('Unexpected end of input')) {
                    koreanMsg = '문법 오류: 코드가 완성되지 않았어요. 닫는 괄호 }를 확인해보세요!';
                } else if (message.includes('Unexpected identifier')) {
                    koreanMsg = '문법 오류: 잘못된 위치에 단어가 있어요. 앞 줄에 세미콜론이 빠졌나요?';
                } else {
                    koreanMsg = '문법 오류: 코드 작성 규칙에 맞지 않아요. ' + message;
                }
            }
            // RangeError translations
            else if (errorType === 'RangeError') {
                if (message.includes('Maximum call stack')) {
                    koreanMsg = '범위 오류: 코드가 무한 반복되고 있어요! 반복 조건을 확인해보세요.';
                } else {
                    koreanMsg = '범위 오류: 숫자가 너무 크거나 작아요';
                }
            }
            // Generic fallback
            else {
                koreanMsg = '오류가 발생했어요: ' + message;
            }

            // Add line number if available
            if (lineNumber !== null && lineNumber > 0) {
                koreanMsg = '줄 ' + lineNumber + '에서 ' + koreanMsg;
            }

            return {
                korean: koreanMsg,
                original: errorType + ': ' + message
            };
        }

        function logToConsole(text, type) {
            var output = document.getElementById('console-output');
            var line = document.createElement('div');
            line.className = type ? 'console-' + type : 'console-log';
            line.textContent = text;
            output.appendChild(line);
            output.parentElement.scrollTop = output.parentElement.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
        }

        async function runCode() {
            if (isRunning) return;
            isRunning = true;
            clearConsole();
            physics.reset();
            droneAPI.reset();

            document.getElementById('btn-run').textContent = '실행 중...';
            document.getElementById('exec-status').classList.add('active');

            var code = document.getElementById('code-editor').value;
            logToConsole('프로그램 실행 시작...', 'info');

            // console.log 오버라이드
            var origLog = console.log;
            console.log = function () {
                var msg = Array.from(arguments).join(' ');
                logToConsole(msg, 'log');
                origLog.apply(console, arguments);
            };

            try {
                var drone = droneAPI;
                var asyncFn = new Function('drone', 'console', 'window', 'document', 'localStorage', 'fetch',
                    'return (async function() {\n' + code + '\n})();'
                );
                await asyncFn(drone, console, undefined, undefined, undefined, undefined);
                logToConsole('프로그램 실행 완료!', 'success');
            } catch (e) {
                var translated = translateError(e);
                logToConsole(translated.korean, 'error');

                // Log original error in smaller gray text for teachers
                var output = document.getElementById('console-output');
                var detail = document.createElement('div');
                detail.className = 'console-error-detail';
                detail.textContent = '원본: ' + translated.original;
                output.appendChild(detail);
                output.parentElement.scrollTop = output.parentElement.scrollHeight;
            }

            console.log = origLog;
            isRunning = false;
            document.getElementById('btn-run').textContent = '▶ 실행';
            setTimeout(function () {
                document.getElementById('exec-status').classList.remove('active');
            }, 1500);
        }

        function stopCode() {
            droneAPI.cancel();
            if (droneAPI._autopilot) droneAPI._autopilot.stop();
            isRunning = false;
            document.getElementById('btn-run').textContent = '▶ 실행';
            document.getElementById('exec-status').classList.remove('active');
            logToConsole('실행이 중지되었습니다.', 'error');
        }

        function resetAll() {
            stopCode();
            physics.reset();
            droneModel.updateFromPhysics(physics.getState());
            clearConsole();
            logToConsole('리셋 완료', 'info');
        }

        function bindButtons() {
            document.getElementById('btn-run').addEventListener('click', runCode);
            document.getElementById('btn-stop').addEventListener('click', stopCode);
            document.getElementById('btn-reset').addEventListener('click', resetAll);

            // 데모 코드 버튼
            document.getElementById('demo-square').addEventListener('click', function () {
                document.getElementById('code-editor').value = DEMOS.square;
            });
            document.getElementById('demo-flyto').addEventListener('click', function () {
                document.getElementById('code-editor').value = DEMOS.flyto;
            });
            document.getElementById('demo-patrol').addEventListener('click', function () {
                document.getElementById('code-editor').value = DEMOS.patrol;
            });
            document.getElementById('demo-path').addEventListener('click', function () {
                document.getElementById('code-editor').value = DEMOS.path;
            });

            // Tab 키 지원 (에디터에서 인덴트)
            document.getElementById('code-editor').addEventListener('keydown', function (e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    var start = this.selectionStart;
                    var end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 2;
                }
                // Ctrl+Enter로 실행
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    runCode();
                }
            });
        }

        var _debugEl = null;
        var _debugCounter = 0;
        function animate() {
            requestAnimationFrame(animate);
            var dt = Math.min(clock.getDelta(), 0.05);

            // 코딩 입력 > 자율비행 > 호버링 우선순위
            var overrideInput = droneAPI.getInputOverride ? droneAPI.getInputOverride() : null;
            var ap = droneAPI._autopilot;
            var autoInput = ap ? ap.update(dt) : null;
            var activeInput = null;
            if (overrideInput && physics.isFlying && !physics.isLanding) {
                activeInput = overrideInput;
                physics.update(dt, overrideInput);
            } else if (autoInput && physics.isFlying && !physics.isLanding) {
                activeInput = autoInput;
                physics.update(dt, autoInput);
            } else {
                physics.update(dt, {});
            }

            var state = physics.getState();
            droneModel.updateFromPhysics(state);
            droneModel.updatePropellers(dt, physics.isFlying ? 0.5 : 0);
            cameraSystem.update(dt);

            // 미션 업데이트
            if (window._codingMissionTick) window._codingMissionTick(dt, state);

            // 디버그 오버레이 업데이트 (5프레임마다)
            if (++_debugCounter % 5 === 0) {
                if (!_debugEl) _debugEl = document.getElementById('debug-overlay');
                if (_debugEl) {
                    var p = state.position;
                    var v = state.velocity;
                    var spd = state.speed;
                    var lines = '<span class="lbl">Pos</span> X:' + p.x.toFixed(1) + ' Y:' + p.y.toFixed(1) + ' Z:' + p.z.toFixed(1);
                    lines += '\n<span class="lbl">Vel</span> ' + v.x.toFixed(1) + ',' + v.y.toFixed(1) + ',' + v.z.toFixed(1) + '  Spd:' + spd.toFixed(1);
                    if (ap && ap.target) {
                        var t = ap.target;
                        var dx = t.x - p.x, dy = t.y - p.y, dz = t.z - p.z;
                        var dist = Math.sqrt(dx*dx+dy*dy+dz*dz);
                        lines += '\n<span class="tgt">Tgt</span> ' + t.x.toFixed(1) + ',' + t.y.toFixed(1) + ',' + t.z.toFixed(1) + '  D:' + dist.toFixed(1) + 'm';
                    }
                    if (activeInput) {
                        lines += '\n<span class="inp">In</span>  P:' + (activeInput.pitch||0).toFixed(2) + ' R:' + (activeInput.roll||0).toFixed(2) + ' T:' + (activeInput.throttle||0).toFixed(2) + ' Y:' + (activeInput.yaw||0).toFixed(2);
                    }
                    _debugEl.innerHTML = lines;
                }
            }

            renderer.render(scene, camera);
        }

        initSimulator();
        bindButtons();

        // 블록 코딩에서 가져온 코드 확인
        (function checkBlocklyImport() {
            var importedCode = localStorage.getItem('drone-blockly-export');
            var urlParams = new URLSearchParams(window.location.search);

            if (importedCode && urlParams.get('from') === 'blockly') {
                document.getElementById('code-editor').value = importedCode;
                localStorage.removeItem('drone-blockly-export');

                var notification = document.createElement('div');
                notification.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#4a9eff;color:#fff;padding:12px 24px;border-radius:8px;font-size:14px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.4);';
                notification.textContent = '블록 코딩에서 가져온 코드입니다. 자유롭게 수정해보세요! ✏️';
                document.body.appendChild(notification);
                setTimeout(function () { notification.remove(); }, 3000);
            }
        })();

        animate();
    })();
    </script>

    <!-- 미션 시스템 초기화 -->
    <script>
    (function() {
        'use strict';

        var missionManager = null;
        var missionUI = null;
        var activeMissionIndex = -1;

        function updateModeProgress() {
            if (!missionManager) return;
            var completed = 0;
            for (var i = 0; i < 6; i++) {
                if (missionManager.getMissionStars(i) > 0) completed++;
            }
            var el = document.getElementById('mode-progress');
            if (el) el.textContent = '&#x1F4BB; 과제 ' + completed + '/6 완료';
        }

        function showHint(text) {
            var hintDiv = document.getElementById('mission-hint');
            var hintText = document.getElementById('hint-text');
            if (hintDiv && hintText) {
                hintText.textContent = text;
                hintDiv.style.display = 'block';
            }
        }

        function hideHint() {
            var hintDiv = document.getElementById('mission-hint');
            if (hintDiv) hintDiv.style.display = 'none';
        }

        function stopActiveMission() {
            if (missionManager && missionManager.isRunning) {
                var cm = missionManager.currentMission;
                if (cm && cm.cleanup) cm.cleanup(window._codingScene);
                missionManager.stopMission();
            }
            if (missionUI) missionUI.hideMissionHUD();
            hideHint();
            activeMissionIndex = -1;
        }

        function startMission(index) {
            stopActiveMission();

            var missions = window.DroneSim.createCodingMissions();
            missionManager = new window.DroneSim.MissionManager('drone-coding-progress');
            missions.forEach(function(m) { missionManager.addMission(m); });

            missionUI = new window.DroneSim.MissionSelectUI(missionManager, null, null);

            activeMissionIndex = index;
            var mission = missionManager.missions[index];

            // 3D 마커 setup
            if (mission.setup && window._codingScene) {
                mission.setup(window._codingScene);
            }

            missionManager.startMission(index);
            missionUI.showMissionHUD(missionManager.currentMission);

            // 스타터 코드 로드
            if (mission.starterCode) {
                var editor = document.getElementById('code-editor');
                if (editor) editor.value = mission.starterCode;
            }

            // 힌트 표시
            if (mission.hint) showHint(mission.hint);

            // 콘솔에 미션 안내
            var output = document.getElementById('console-output');
            if (output) {
                var line = document.createElement('div');
                line.className = 'console-info';
                line.textContent = '[미션 ' + (index + 1) + '] ' + mission.name + ' - ' + mission.description;
                output.innerHTML = '';
                output.appendChild(line);
            }

            missionManager.onMissionComplete = function(result) {
                if (missionUI) missionUI.hideMissionHUD();
                hideHint();

                // cleanup 3D markers
                var m = missionManager.missions[index];
                if (m && m.cleanup && window._codingScene) m.cleanup(window._codingScene);

                updateModeProgress();

                missionUI.showResult(
                    result,
                    function() { startMission(index); },        // retry
                    function() {                                  // next
                        if (index + 1 < 6) startMission(index + 1);
                    },
                    function() {                                  // menu
                        activeMissionIndex = -1;
                        missionUI.show();
                    }
                );
            };

            missionManager.onMissionFail = function(result) {
                if (missionUI) missionUI.hideMissionHUD();
                hideHint();

                var m = missionManager.missions[index];
                if (m && m.cleanup && window._codingScene) m.cleanup(window._codingScene);

                missionUI.showResult(
                    result,
                    function() { startMission(index); },
                    null,
                    function() {
                        activeMissionIndex = -1;
                        missionUI.show();
                    }
                );
            };
        }

        function showMissionSelect() {
            var missions = window.DroneSim.createCodingMissions();
            missionManager = new window.DroneSim.MissionManager('drone-coding-progress');
            missions.forEach(function(m) { missionManager.addMission(m); });
            missionUI = new window.DroneSim.MissionSelectUI(
                missionManager,
                function(idx) { startMission(idx); },
                function() { /* closed - free mode */ }
            );
            missionUI.show();
        }

        // 미션 버튼 연결
        document.getElementById('btn-missions').addEventListener('click', showMissionSelect);

        // 자유 코딩 (샌드박스) 모드
        document.getElementById('btn-sandbox').addEventListener('click', function () {
            stopActiveMission();
            hideHint();
            var editor = document.getElementById('code-editor');
            if (editor) {
                editor.value = '// 자유 코딩 모드!\n// 드론 API를 자유롭게 사용해보세요.\n// Ctrl+Enter로 실행할 수 있어요.\n\nawait drone.takeoff();\n\n// 여기에 자유롭게 코드를 작성하세요!\n// 예: for문, if문, function 모두 사용 가능\n\n// async function myPattern(size) {\n//   for (let i = 0; i < 4; i++) {\n//     await drone.moveForward(size);\n//     await drone.turnRight(90);\n//   }\n// }\n// await myPattern(5);\n\nawait drone.land();\n';
            }
            var output = document.getElementById('console-output');
            if (output) {
                output.innerHTML = '';
                var line = document.createElement('div');
                line.className = 'console-info';
                line.textContent = '자유 코딩 모드! 원하는 코드를 작성하고 실행해보세요.';
                output.appendChild(line);
            }
        });

        // animate 루프에서 미션 업데이트 훅
        // window._codingMissionTick 를 animate() 내부에서 호출
        window._codingMissionTick = function(dt, state) {
            if (!missionManager || !missionManager.isRunning) return;

            // frameUpdate는 currentMission 컨텍스트에서 호출 (mutable 상태가 거기 있음)
            var cm = missionManager.currentMission;
            if (cm && cm.frameUpdate) {
                cm.frameUpdate(state);
            }

            missionManager.update(dt, state);
            if (missionUI) missionUI.updateMissionHUD(missionManager.currentMission, missionManager.missionTime);
        };

        // 초기 진행도 표시
        (function initProgress() {
            var mgr = new window.DroneSim.MissionManager('drone-coding-progress');
            var missions = window.DroneSim.createCodingMissions();
            missions.forEach(function(m) { mgr.addMission(m); });
            var completed = 0;
            for (var i = 0; i < 6; i++) {
                if (mgr.getMissionStars(i) > 0) completed++;
            }
            var el = document.getElementById('mode-progress');
            if (el) el.textContent = '&#x1F4BB; 과제 ' + completed + '/6 완료';
        })();
    })();
    </script>
</body>
</html>
